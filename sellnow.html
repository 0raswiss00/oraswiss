
<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shto or√´ (sell now)</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="admin.css">
 
<style>
  body{font-family:Arial,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:20px}
  .wrap{max-width:900px;margin:0 auto}
  .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;margin:12px 0 6px;color:#ddd}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
  textarea{min-height:90px}
  .btn{margin-top:14px;padding:12px 14px;border-radius:12px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;cursor:pointer}
  .btn:hover{background:#1a1a1a}
  .note{opacity:.85;font-size:13px;margin-top:8px;line-height:1.4}
  .ok{color:#25D366}
  .bad{color:#ff6b6b}

  /* extra */
  body { padding: 16px; font-family: system-ui, -apple-system, BlinkMacSystemFont; }
  .btn { padding: 14px 18px; font-size: 16px; border-radius: 8px; }
  #photosPreview img { width: 120px; height: auto; margin: 8px; border-radius: 6px; }

  .logo-center{
    display:flex;
    justify-content:center;
    margin: 10px 0 30px;
  }
  .logo-center img{
    height: 200px;
  }
</style>
    
     
</head>

<body class="sell-page">
<div class="wrap">

  <!-- ‚úÖ LOGO N√ã MES (SIP√ãR) -->
  <div class="logo-center">
    <img src="images/oraswiss-logo.png" alt="OraSwiss Logo">
  </div>

  <div class="top">
    <h2 style="margin:0">Shto or√´ (sell now)</h2>
    <button class="btn" type="button" onclick="history.back()">‚Üê Back</button>
  </div>

  <div class="note">
    1) Kliko <b>Upload Photos</b> (ngarkon fotot dhe mbush automatikisht URL-t√´)<br/>
    2) Plot√´so fushat<br/>
    3) Kliko <b>PUBLISH</b> ‚Üí shkon n√´ Supabase me status <b>pending</b>
  </div>

  <label>Category</label>
  <select id="category">
    <option value="luxury">Luxury</option>
    <option value="vintage" selected>Vintage</option>
    <option value="parts">Parts</option>
  </select>

  <div class="row">
    <div><label>Brand</label><input id="brand" placeholder="Omega"></div>
    <div><label>Model</label><input id="model" placeholder="Seamaster"></div>
  </div>

  <div class="row">
    <div><label>Ref</label><input id="ref" placeholder="2400-4"></div>
    <div><label>Year</label><input id="year" type="number" placeholder="1999"></div>
  </div>

  <div class="row">
    <div><label>Material</label><input id="material" placeholder="Steel"></div>
    <div><label>Case Size (mm)</label><input id="case_size" type="number" placeholder="35"></div>
  </div>

  <div class="row">
    <div>
      <label>Condition</label>
      <select id="condition">
        <option>New</option>
        <option>Like New</option>
        <option selected>Very Good</option>
        <option>Good</option>
        <option>Used - Fair</option>
      </select>
    </div>
    <div><label>Price (‚Ç¨)</label><input id="price" type="number" placeholder="900"></div>
  </div>

  <div class="row">
    <div>
      <label>Box & Papers</label>
      <select id="box">
        <option value="">Nuk e di</option>
        <option value="fullset">Box & Papers</option>
        <option value="box_only">Vet√´m Box</option>
        <option value="papers_only">Vet√´m Papers</option>
        <option value="none">Pa Box / Papers</option>
      </select>
    </div>
    <div>
      <label>Working</label>
      <select id="working">
        <option value="">Nuk e di</option>
        <option value="working">Working</option>
        <option value="not_working">Not working</option>
      </select>
    </div>
  </div>

<label>Description</label>
<textarea id="description" placeholder="Shkruaj p√´rshkrimin..."></textarea>
  

<!-- BUTONI Q√ã KLIKOHET -->
<button id="chooseBtn" type="button">Upload Photos</button>

<input
  id="photoFiles"
  type="file"
  accept="image/*"
  multiple
  style="position:fixed; left:-9999px;"
/>
<div id="msg"></div>

<button id="uploadBtn" type="button">NGARKO FOTOT</button>

<button id="publishBtn" type="button">PUBLISH</button>
  

  
<script type="module">
  // =========================
  // 1) IMPORTS (DUHET N√ã KRYE)
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";

  import {
    getAuth,
    onAuthStateChanged,
    setPersistence,
    browserLocalPersistence,
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  // =========================
  // 2) FIREBASE CONFIG
  // =========================
  const firebaseConfig = {
    apiKey: "AIZA... (apiKey yt)",
    authDomain: "oraswiss-27e57.firebaseapp.com",
    projectId: "oraswiss-27e57",
    storageBucket: "oraswiss-27e57.firebasestorage.app",
    messagingSenderId: "596627676936",
    appId: "1:596627676936:web:0c96cf820fef4e979616bd",
    measurementId: "G-VZPKMD67VQ",
  };

  // =========================
  // 3) INIT
  // =========================
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // persistence (ruan login n√´ browser)
  setPersistence(auth, browserLocalPersistence).catch(console.error);

  // =========================
  // 4) DOM ELEMENTS
  // =========================
  const chooseBtn = document.getElementById("chooseBtn");
  const fileInput = document.getElementById("photoFiles");
  const uploadBtn = document.getElementById("uploadBtn");
  const publishBtn = document.getElementById("publishBtn");
  const msg = document.getElementById("msg");

  // k√´to i ke n√´ form√´ (nga fotot e tua duken)
  const refEl = document.getElementById("ref");
  const materialEl = document.getElementById("material");
  const conditionEl = document.getElementById("condition");
  const boxEl = document.getElementById("boxpapers");
  const yearEl = document.getElementById("year");
  const sizeEl = document.getElementById("casesize");
  const priceEl = document.getElementById("price");
  const workingEl = document.getElementById("working");
  const descEl = document.getElementById("description");

  function setMsg(t) {
    if (msg) msg.textContent = t;
  }

  // =========================
  // 5) STATE
  // =========================
  let currentUser = null;
  let selectedFiles = [];
  let uploadedUrls = [];

  // fillo disabled
  uploadBtn.disabled = true;
  publishBtn.disabled = true;

  // =========================
  // 6) AUTH STATE (VET√ãM 1 HER√ã)
  // =========================
  onAuthStateChanged(auth, (user) => {
    currentUser = user;

    if (user) {
      setMsg("‚úÖ I loguar si: " + (user.email || user.uid));
      // upload/publish aktivizohen vet√´m pasi zgjedh foto
      uploadBtn.disabled = selectedFiles.length === 0;
      publishBtn.disabled = true; // aktivizohet vet√´m pasi ngarkohen fotot
    } else {
      setMsg("‚ùå Duhet t√´ jesh i loguar");
      uploadBtn.disabled = true;
      publishBtn.disabled = true;
      uploadedUrls = [];
    }
  });

  // =========================
  // 7) CHOOSE BUTTON -> HAP FILE PICKER
  // =========================
  chooseBtn.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", () => {
    selectedFiles = Array.from(fileInput.files || []);
    uploadedUrls = [];
    publishBtn.disabled = true;

    if (selectedFiles.length === 0) {
      setMsg("‚ùå Zgjidh foto");
      uploadBtn.disabled = true;
      return;
    }

    setMsg("üì∏ U zgjodh√´n " + selectedFiles.length + " foto");
    uploadBtn.disabled = !currentUser; // vet√´m n√´se √´sht√´ loguar
  });

  // =========================
  // üòé UPLOAD REAL N√ã STORAGE
  // =========================
  uploadBtn.addEventListener("click", async () => {
    try {
      if (!currentUser) throw new Error("Duhet t√´ jesh i loguar");
      if (selectedFiles.length === 0) throw new Error("Zgjidh t√´ pakt√´n 1 foto");

      uploadBtn.disabled = true;
      publishBtn.disabled = true;
      setMsg("‚è≥ Duke ngarkuar " + selectedFiles.length + " foto...");

      const urls = [];
      for (const file of selectedFiles) {
        // path unik
        const safeName = file.name.replace(/\s+/g, "_");
        const path = listings/${currentUser.uid}/${Date.now()}_${safeName};
        const storageRef = ref(storage, path);

        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        urls.push(url);
      }

      uploadedUrls = urls;

      setMsg("‚úÖ U ngarkuan " + uploadedUrls.length + " foto");
      publishBtn.disabled = false; // tani mund t√´ publikosh
    } catch (e) {
      console.error(e);
      setMsg("‚ùå " + (e?.message || "Gabim n√´ upload"));
    } finally {
      // lejo upload prap n√´se ka file t√´ zgjedhura dhe user
      uploadBtn.disabled = !(currentUser && selectedFiles.length > 0);
    }
  });

  // =========================
  // 9) PUBLISH -> FIRESTORE
  // =========================
  publishBtn.addEventListener("click", async () => {
    try {
      if (!currentUser) throw new Error("Duhet t√´ jesh i loguar");
      if (uploadedUrls.length === 0) throw new Error("Ngarko fotot fillimisht");

      publishBtn.disabled = true;
      setMsg("‚è≥ Duke publikuar...");

      const data = {
        ownerUid: currentUser.uid,
        ownerEmail: currentUser.email || null,

        ref: refEl?.value?.trim() || "",
        material: materialEl?.value?.trim() || "",
        condition: conditionEl?.value?.trim() || "",
        boxpapers: boxEl?.value?.trim() || "",
        year: yearEl?.value?.trim() || "",
        casesize: sizeEl?.value?.trim() || "",
        price: priceEl?.value?.trim() || "",
        working: workingEl?.value?.trim() || "",
        description: descEl?.value?.trim() || "",

        photos: uploadedUrls,
        createdAt: serverTimestamp(),
      };

      await addDoc(collection(db, "listings"), data);

      setMsg("‚úÖ U publikua me sukses!");
      // reset
      fileInput.value = "";
      selectedFiles = [];
      uploadedUrls = [];
      uploadBtn.disabled = true;
      publishBtn.disabled = true;
    } catch (e) {
      console.error(e);
      setMsg("‚ùå " + (e?.message || "Gabim n√´ publish"));
      publishBtn.disabled = uploadedUrls.length === 0;
    }
  });
</script>


</body>
</html>
