<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sell Now</title>
  <style>
    #chooseBtn { cursor: pointer; display: inline-block; padding: 10px 14px; border: 1px solid #ccc; }
    button { padding: 10px 14px; margin-left: 6px; }
    #msg { margin-top: 10px; font-family: Arial, sans-serif; }
  </style>
</head>
<body>

  <!-- shembull input-esh (nqs i ke ndryshe, ndrysho vet√´m id-t√´ k√´tu ose posht√´ te JS) -->
  <input id="brand" placeholder="Brand" />
  <input id="model" placeholder="Model" />
  <input id="category" placeholder="Category" />
  <input id="ref" placeholder="Ref" />
  <input id="year" type="number" placeholder="Year" />
  <input id="material" placeholder="Material" />
  <input id="caseSize" type="number" placeholder="Case Size" />
  <input id="condition" placeholder="Condition" />
  <input id="price" type="number" placeholder="Price" />
  <input id="country" placeholder="Country" />
  <input id="fullName" placeholder="Full Name" />
  <input id="email" placeholder="Email" />
  <input id="phone" placeholder="Phone" />
  <textarea id="description" placeholder="Description"></textarea>

  <br><br>

  <!-- ‚úÖ KJO E HAP FILE PICKER 100% -->
  <label id="chooseBtn" for="photoFiles">Upload Photos</label>
  <input id="photoFiles" type="file" accept="image/*" multiple style="display:none;" />

  <button id="uploadBtn" type="button">NGARKO FOTOT</button>
  <button id="publishBtn" type="button">PUBLISH</button>

  <div id="msg"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "‚Ä¶",
      authDomain: "oraswiss-27e57.firebaseapp.com",
      projectId: "oraswiss-27e57",
      storageBucket: "oraswiss-27e57.appspot.com",
      messagingSenderId: "‚Ä¶",
      appId: "‚Ä¶"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    const fileInput = document.getElementById("photoFiles");
    const uploadBtn = document.getElementById("uploadBtn");
    const publishBtn = document.getElementById("publishBtn");
    const msg = document.getElementById("msg");

    const el = (id) => document.getElementById(id);

    let uploadedPhotoURLs = []; // ruan URL pasi ngarkohen

    function setMsg(t) {
      msg.textContent = t;
    }

    // kur zgjedh foto
    fileInput.addEventListener("change", () => {
      uploadedPhotoURLs = []; // reset nqs zgjedh foto te reja
      const n = fileInput.files ? fileInput.files.length : 0;
      setMsg(n ? üìÇ U zgjodh√´n ${n} foto : "‚ùå S‚Äôu zgjodh asnj√´ foto");
    });

    // ngarko foto ne Storage
    uploadBtn.addEventListener("click", async () => {
      try {
        const files = fileInput.files;
        if (!files || files.length === 0) {
          setMsg("‚ùå Zgjidh foto fillimisht");
          return;
        }

        setMsg("‚è≥ Duke ngarkuar fotot...");

        const userId = "QSFTjh6AddTjxgbTkR47mBpMjX2"; // nqs ke auth, e merr nga auth.uid
        const uploads = Array.from(files).map(async (file, idx) => {
          const safeName = (file.name || "photo").replace(/\s+/g, "_");
          const path = watches/${userId}/${Date.now()}_${idx}_${safeName};
          const storageRef = sRef(storage, path);

          await uploadBytes(storageRef, file);
          return await getDownloadURL(storageRef);
        });

        uploadedPhotoURLs = await Promise.all(uploads);

        setMsg(‚úÖ Foto u ngarkuan (${uploadedPhotoURLs.length}));
      } catch (err) {
        console.error(err);
        setMsg("‚ùå Gabim gjat√´ upload fotove (shiko Console)");
      }
    });

    // publish -> ruan dokumentin ne Firestore bashke me URL e fotove
    publishBtn.addEventListener("click", async () => {
      try {
        setMsg("‚è≥ Duke publikuar...");

        // nqs do ta detyrosh me foto:
        if (!uploadedPhotoURLs || uploadedPhotoURLs.length === 0) {
          setMsg("‚ùå S√´ pari NGARKO FOTOT, pastaj PUBLISH");
          return;
        }

        const data = {
          brand: el("brand")?.value?.trim() || "",
          model: el("model")?.value?.trim() || "",
          category: el("category")?.value?.trim() || "",
          ref: el("ref")?.value?.trim() || "",
          year: Number(el("year")?.value || 0) || null,
          material: el("material")?.value?.trim() || "",
          caseSize: Number(el("caseSize")?.value || 0) || null,
          condition: el("condition")?.value?.trim() || "",
          price: Number(el("price")?.value || 0) || null,

          country: el("country")?.value?.trim() || "",
          fullName: el("fullName")?.value?.trim() || "",
          email: el("email")?.value?.trim() || "",
          phone: el("phone")?.value?.trim() || "",
          description: el("description")?.value?.trim() || "",

          photos: uploadedPhotoURLs,              // ‚úÖ URL-te e fotove
          status: "pending",                      // ose "active"
          userId: "QSFTjh6AddTjxgbTkR47mBpMjX2",  // ose auth uid
          createdAt: serverTimestamp()            // ‚úÖ timestamp nga serveri
        };

        await addDoc(collection(db, "watches"), data);

        setMsg("üöÄ Publish OK");

        // reset
        uploadedPhotoURLs = [];
        fileInput.value = "";
      } catch (err) {
        console.error(err);
        setMsg("‚ùå Gabim gjat√´ publish (shiko Console)");
      }
    });
  </script>

</body>
</html>

