<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shto or√´ (Admin)</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="admin.css">
  

  <script>
    console.log("supabase =", window.supabase);
  </script>
  
  <style>
    body{font-family:Arial,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:20px}
    .wrap{max-width:900px;margin:0 auto}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){.row{grid-template-columns:1fr}}
    label{display:block;margin:12px 0 6px;color:#ddd}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
    textarea{min-height:90px}
    .btn{margin-top:14px;padding:12px 14px;border-radius:12px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;cursor:pointer}
    .btn:hover{background:#1a1a1a}
    .note{opacity:.85;font-size:13px;margin-top:8px;line-height:1.4}
    .ok{color:#25D366}
    .bad{color:#ff6b6b}
  </style>
</head>

<body> 
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistrations()
    .then(rs => rs.forEach(r => r.unregister()));
}
</script>
<div class="wrap">

  <div class="top">
    <h2 style="margin:0">Shto or√´ (Admin)</h2>
    <button class="btn" type="button" onclick="history.back()">‚Üê Back</button>
  </div>

  <div class="note">
    1) Kliko <b>Upload Photos</b> (ngarkon fotot dhe mbush automatikisht URL-t√´)<br/>
    2) Plot√´so fushat<br/>
    3) Kliko <b>PUBLISH</b> ‚Üí shkon n√´ Supabase me status <b>approved</b>
  </div>

  <label>Category</label>
  <select id="category">
    <option value="luxury">Luxury</option>
    <option value="vintage" selected>Vintage</option>
    <option value="parts">Parts</option>
  </select>

  <div class="row">
    <div><label>Brand</label><input id="brand" placeholder="Omega"></div>
    <div><label>Model</label><input id="model" placeholder="Seamaster"></div>
  </div>

  <div class="row">
    <div><label>Ref</label><input id="ref" placeholder="2400-4"></div>
    <div><label>Year</label><input id="year" type="number" placeholder="1999"></div>
  </div>

  <div class="row">
    <div><label>Material</label><input id="material" placeholder="Steel"></div>
    <div><label>Case Size (mm)</label><input id="case_size" type="number" placeholder="35"></div>
  </div>

  <div class="row">
    <div>
      <label>Condition</label>
      <select id="condition">
        <option>New</option>
        <option>Like New</option>
        <option selected>Very Good</option>
        <option>Good</option>
        <option>Used - Fair</option>
      </select>
    </div>
    <div><label>Price (‚Ç¨)</label><input id="price" type="number" placeholder="900"></div>
  </div>

  <div class="row">
    <div>
      <label>Box & Papers</label>
      <select id="box">
        <option value="">Nuk e di</option>
        <option value="fullset">Box & Papers</option>
        <option value="box_only">Vet√´m Box</option>
        <option value="papers_only">Vet√´m Papers</option>
        <option value="none">Pa Box / Papers</option>
      </select>
    </div>
    <div>
      <label>Working</label>
      <select id="working">
        <option value="">Nuk e di</option>
        <option value="working">Working</option>
        <option value="not_working">Not working</option>
      </select>
    </div>
  </div>

  <label>Description</label>
  <textarea id="description" placeholder="Shkruaj detaje..."></textarea>

  <label>Photos (URLs)</label>
  <button class="btn" id="uploadBtn" type="button">Upload Photos</button>
  <textarea id="photos" placeholder="URL-t√´ dalin k√´tu (automatikisht)..." readonly></textarea>

  <button class="btn" id="publishBtn" type="button">PUBLISH</button>

  <div id="msg" class="note"></div>

</div>

<!-- Cloudinary -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<script>
  const CLOUD_NAME = "drfjznv52";
  const UPLOAD_PRESET = "oraswiss_upload";

  const widget = cloudinary.createUploadWidget(
    {
      cloudName: CLOUD_NAME,
      uploadPreset: UPLOAD_PRESET,
      folder: "watches",
      multiple: true,
      sources: ["local", "camera"]
    },
    (error, result) => {
      if (error) { console.error(error); return; }
      if (result && result.event === "success") {
        const ta = document.getElementById("photos");
        const current = ta.value.trim();
        ta.value = current ? (current + "\n" + result.info.secure_url) : result.info.secure_url;
      }
    }
  );

  document.getElementById("uploadBtn").addEventListener("click", () => widget.open());
</script>

<!-- Supabase (v2) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  // ‚úÖ Vendos k√´tu t√´ tuat (Settings ‚Üí API)
  const SUPABASE_URL = "https://gnwsrmelmeqduhhfmtoa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  
  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );
  
  function msg(text, ok = true) {
    const el = document.getElementById("msg");
    el.className = "note " + (ok ? "ok" : "bad");
    el.textContent = text;
  }

  document.getElementById("publishBtn").addEventListener("click", async () => {
    try {
      const photosText = document.getElementById("photos").value.trim();
      if (!photosText) { msg("Ngarko t√´ pakt√´n 1 foto.", false); return; }

      const photos = photosText
        .split(/\n|,/g)
        .map(s => s.trim())
        .filter(Boolean);

      const data = {
        category: document.getElementById("category").value,
        brand: document.getElementById("brand").value.trim(),
        model: document.getElementById("model").value.trim(),
        ref: document.getElementById("ref").value.trim(),
        year: document.getElementById("year").value ? Number(document.getElementById("year").value) : null,
        material: document.getElementById("material").value.trim(),
        condition: document.getElementById("condition").value,
        description: document.getElementById("description").value.trim(),
        case_size: document.getElementById("case_size").value ? Number(document.getElementById("case_size").value) : null,
        price: document.getElementById("price").value ? Number(document.getElementById("price").value) : null,
        photos: photos,
        box: document.getElementById("box").value || null,
        working: document.getElementById("working").value || null,
        status: "approved",
      };

      msg("Duke d√´rguar...", true);

      // üî¥ INSERT (futja n√´ databaz√´)
      const { error } = await supabaseClient
        .from("listings")
        .insert([data]);

      if (error) {
        console.error(error);
        msg("Gabim Supabase: " + error.message, false);
        return;
      }

      msg("U d√´rgua ‚úÖ (pending).", true);

      // (opsionale) pastro form√´n
      // document.getElementById("photos").value = "";
      // document.getElementById("brand").value = "";
      // ...
    } catch (e) {
      console.error(e);
      msg("Gabim rrjeti/JS: " + (e?.message || String(e)), false);
    }
  });
</script>
  
</body>
</html>
