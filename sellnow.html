<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shto or√´ (sell now)</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="admin.css">
 
<style>
  body{font-family:Arial,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:20px}
  .wrap{max-width:900px;margin:0 auto}
  .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;margin:12px 0 6px;color:#ddd}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
  textarea{min-height:90px}
  .btn{margin-top:14px;padding:12px 14px;border-radius:12px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;cursor:pointer}
  .btn:hover{background:#1a1a1a}
  .note{opacity:.85;font-size:13px;margin-top:8px;line-height:1.4}
  .ok{color:#25D366}
  .bad{color:#ff6b6b}

  /* extra */
  body { padding: 16px; font-family: system-ui, -apple-system, BlinkMacSystemFont; }
  .btn { padding: 14px 18px; font-size: 16px; border-radius: 8px; }
  #photosPreview img { width: 120px; height: auto; margin: 8px; border-radius: 6px; }

  .logo-center{
    display:flex;
    justify-content:center;
    margin: 10px 0 30px;
  }
  .logo-center img{
    height: 200px;
  }
</style>
    
     
</head>

<body class="sell-page">
<div class="wrap">

  <!-- ‚úÖ LOGO N√ã MES (SIP√ãR) -->
  <div class="logo-center">
    <img src="images/oraswiss-logo.png" alt="OraSwiss Logo">
  </div>

  <div class="top">
    <h2 style="margin:0">Shto or√´ (sell now)</h2>
    <button class="btn" type="button" onclick="history.back()">‚Üê Back</button>
  </div>

  <div class="note">
    1) Kliko <b>Upload Photos</b> (ngarkon fotot dhe mbush automatikisht URL-t√´)<br/>
    2) Plot√´so fushat<br/>
    3) Kliko <b>PUBLISH</b> ‚Üí shkon n√´ Supabase me status <b>pending</b>
  </div>

  <label>Category</label>
  <select id="category">
    <option value="luxury">Luxury</option>
    <option value="vintage" selected>Vintage</option>
    <option value="parts">Parts</option>
  </select>

  <div class="row">
    <div><label>Brand</label><input id="brand" placeholder="Omega"></div>
    <div><label>Model</label><input id="model" placeholder="Seamaster"></div>
  </div>

  <div class="row">
    <div><label>Ref</label><input id="ref" placeholder="2400-4"></div>
    <div><label>Year</label><input id="year" type="number" placeholder="1999"></div>
  </div>

  <div class="row">
    <div><label>Material</label><input id="material" placeholder="Steel"></div>
    <div><label>Case Size (mm)</label><input id="case_size" type="number" placeholder="35"></div>
  </div>

  <div class="row">
    <div>
      <label>Condition</label>
      <select id="condition">
        <option>New</option>
        <option>Like New</option>
        <option selected>Very Good</option>
        <option>Good</option>
        <option>Used - Fair</option>
      </select>
    </div>
    <div><label>Price (‚Ç¨)</label><input id="price" type="number" placeholder="900"></div>
  </div>

  <div class="row">
    <div>
      <label>Box & Papers</label>
      <select id="box">
        <option value="">Nuk e di</option>
        <option value="fullset">Box & Papers</option>
        <option value="box_only">Vet√´m Box</option>
        <option value="papers_only">Vet√´m Papers</option>
        <option value="none">Pa Box / Papers</option>
      </select>
    </div>
    <div>
      <label>Working</label>
      <select id="working">
        <option value="">Nuk e di</option>
        <option value="working">Working</option>
        <option value="not_working">Not working</option>
      </select>
    </div>
  </div>

<label>Description</label>
<textarea id="description" placeholder="Shkruaj p√´rshkrimin..."></textarea>
  

<!-- BUTONI Q√ã KLIKOHET -->
<button id="chooseBtn" type="button">Upload Photos</button>

<!-- INPUT (JO display:none) -->
<input
  id="photoFiles"
  type="file"
  accept="image/*"
  multiple
  style="position:absolute; left:-9999px;"
/>

<div id="msg"></div>

<button id="uploadBtn" type="button">NGARKO FOTOT</button>

<button id="publishBtn" type="button">PUBLISH</button>
  

  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // üî¥ Firebase config (plot√´so pjes√´t me "‚Ä¶")
  const firebaseConfig = {
    apiKey: "‚Ä¶",
    authDomain: "oraswiss-27e57.firebaseapp.com",
    projectId: "oraswiss-27e57",
    storageBucket: "oraswiss-27e57.appspot.com",
    messagingSenderId: "‚Ä¶",
    appId: "‚Ä¶",
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);
  const db = getFirestore(app);

  // ‚úÖ Shum√´ e r√´nd√´sishme: mos e prek k√´t√´ ‚Äî garanton q√´ element√´t ekzistojn√´
  window.addEventListener("DOMContentLoaded", () => {
    // Buttons / UI
    const chooseBtn = document.getElementById("chooseBtn");
    const fileInput = document.getElementById("photoFiles");
    const uploadBtn = document.getElementById("uploadBtn");
    const publishBtn = document.getElementById("publishBtn");
    const msg = document.getElementById("msg");

    // Form inputs (duhet t√´ ekzistojn√´ n√´ HTML me k√´to id)
    const brandEl = document.getElementById("brand");
    const modelEl = document.getElementById("model");
    const categoryEl = document.getElementById("category");
    const refEl = document.getElementById("ref");
    const yearEl = document.getElementById("year");
    const materialEl = document.getElementById("material");
    const caseSizeEl = document.getElementById("caseSize");
    const conditionEl = document.getElementById("condition");
    const priceEl = document.getElementById("price");

    function setMsg(t) {
      if (msg) msg.textContent = t;
    }

    // ‚úÖ Kontroll i thjesht√´ q√´ mos t√´ bjer√´ skripti n√´se mungon ndonj√´ id
    const required = {
      chooseBtn, fileInput, uploadBtn, publishBtn, msg,
      brandEl, modelEl, categoryEl, refEl, yearEl, materialEl, caseSizeEl, conditionEl, priceEl
    };
    const missing = Object.entries(required).filter(([_, v]) => !v).map(([k]) => k);
    if (missing.length) {
      console.error("Missing HTML elements:", missing);
      setMsg("‚ùå Mungojn√´ disa fusha n√´ HTML (shiko Console).");
      return;
    }

    // Ruajm√´ URL-t√´ e fotove pas upload
    let photoUrls = [];

    // 1) Hap file picker
    chooseBtn.addEventListener("click", (e) => {
      e.preventDefault();
      // mos e b√´j input-in display:none, ndryshe Safari nganj√´her√´ e bllokon
      fileInput.click();
    });

    // 2) Kur zgjidhen fotot
    fileInput.addEventListener("change", () => {
      photoUrls = []; // reset sepse u zgjodh√´n foto t√´ reja
      setMsg("üìÇ U zgjodh√´n " + fileInput.files.length + " foto");
    });

    // Helper: lexon vlerat nga form
    function readForm() {
      const brand = brandEl.value.trim();
      const model = modelEl.value.trim();
      const category = categoryEl.value.trim(); // p.sh. Luxury/Vintage/Parts
      const ref = refEl.value.trim();
      const material = materialEl.value.trim();
      const condition = conditionEl.value.trim();

      const yearRaw = yearEl.value.trim();
      const caseSizeRaw = caseSizeEl.value.trim();
      const priceRaw = priceEl.value.trim();

      const year = yearRaw ? Number(yearRaw) : null;
      const caseSize = caseSizeRaw ? Number(caseSizeRaw) : null;
      const price = priceRaw ? Number(priceRaw) : null;

      return { brand, model, category, ref, material, condition, year, caseSize, price };
    }

    function validateForm(data) {
      if (!data.category) return "Zgjidh Category";
      if (!data.brand) return "Plot√´so Brand";
      if (!data.model) return "Plot√´so Model";
      if (!data.ref) return "Plot√´so Ref";
      if (data.price === null || !Number.isFinite(data.price) || data.price <= 0) return "Vendos Price t√´ sakt√´";
      if (data.year !== null && (!Number.isFinite(data.year) || data.year < 1500 || data.year > 2100)) return "Year jo i sakt√´";
      if (data.caseSize !== null && (!Number.isFinite(data.caseSize) || data.caseSize <= 0 || data.caseSize > 70)) return "Case size jo i sakt√´";
      return null;
    }

    // 3) Upload fotot REALISHT n√´ Storage
    uploadBtn.addEventListener("click", async (e) => {
      e.preventDefault();

      const files = fileInput.files;
      if (!files || files.length === 0) {
        setMsg("‚ùå Zgjidh foto fillimisht");
        return;
      }

      setMsg("‚è≥ Duke ngarkuar fotot...");
      photoUrls = [];

      try {
        for (const file of files) {
          // Em√´r i sigurt
          const safeName = (file.name || "photo")
            .replace(/\s+/g, "_")
            .replace(/[^a-zA-Z0-9._-]/g, "");

          const path = watches/${Date.now()}_${Math.random().toString(16).slice(2)}_${safeName};
          const storageRef = sRef(storage, path);

          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          photoUrls.push(url);
        }

        setMsg("‚úÖ Foto u ngarkuan (" + photoUrls.length + ")");
      } catch (err) {
        console.error("UPLOAD ERROR:", err);
        setMsg("‚ùå Gabim gjat√´ upload (shiko Console)");
      }
    });

    // 4) Publish n√´ Firestore
    publishBtn.addEventListener("click", async (e) => {
      e.preventDefault();

      const data = readForm();
      const errMsg = validateForm(data);
      if (errMsg) {
        setMsg("‚ùå " + errMsg);
        return;
      }

      if (photoUrls.length === 0) {
        setMsg("‚ùå Ngarko fotot para Publish");
        return;
      }

      setMsg("‚è≥ Duke publikuar...");

      try {
        await addDoc(collection(db, "watches"), {
          brand: data.brand,
          model: data.model,
          category: data.category,
          ref: data.ref,
          year: data.year,
          material: data.material,
          caseSize: data.caseSize,
          condition: data.condition,
          price: data.price,

          photos: photoUrls,

          status: "active", // ose "pending"
          userId: "QSFTjh6AddTjxgbTkR47mBpMjX2",

          createdAt: serverTimestamp(),
        });

        setMsg("‚úÖ U publikua me sukses");
      } catch (err) {
        console.error("PUBLISH ERROR:", err);
        setMsg("‚ùå Gabim gjat√´ publish (shiko Console)");
      }
    });
  });
</script>


</body>
</html>
