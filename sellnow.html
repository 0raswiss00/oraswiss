<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sell Now</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    button { padding: 10px 14px; margin: 6px 0; }
    #msg { margin-top: 10px; font-weight: 600; }
  </style>
</head>

<body>

  <button id="chooseBtn" type="button">Upload Photos</button>

  <!-- INPUT (hidden) -->
  <input
    id="photoFiles"
    type="file"
    accept="image/*"
    multiple
    style="position:absolute; left:-9999px;"
  />

  <div id="msg"></div>

  <button id="uploadBtn" type="button">NGARKO FOTOT (TEST)</button>
  <button id="publishBtn" type="button">PUBLISH</button>

  <!-- SCRIPT N√ã FUND (SHUM√ã E R√ãND√ãSISHME) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ‚úÖ Firebase config (vendos vlerat e tua)
    const firebaseConfig = {
      apiKey: "‚Ä¶",
      authDomain: "oraswiss-27e57.firebaseapp.com",
      projectId: "oraswiss-27e57",
      storageBucket: "oraswiss-27e57.appspot.com",
      messagingSenderId: "‚Ä¶",
      appId: "‚Ä¶"
    };

    // ‚úÖ Init
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    // ‚úÖ DOM
    const chooseBtn = document.getElementById("chooseBtn");
    const fileInput = document.getElementById("photoFiles");
    const uploadBtn = document.getElementById("uploadBtn");
    const publishBtn = document.getElementById("publishBtn");
    const msg = document.getElementById("msg");

    function setMsg(t) {
      msg.textContent = t;
    }

    // ‚úÖ TEST userId (m√´ von√´ e merr nga auth)
    const userId = "testUser123";

    // ‚úÖ TEST t√´ dh√´nat (z√´vend√´so me ato q√´ merr nga forma)
    const brand = "Test";
    const model = "Test";
    const category = "Test";
    const condition = "Very Good";
    const price = 100;
    const material = "Steel";

    async function uploadPhotos(uid) {
      const urls = [];

      // Siguri
      if (!fileInput.files || fileInput.files.length === 0) return urls;

      for (const file of fileInput.files) {
        // ‚úÖ BACKTICKS (shum√´ e r√´nd√´sishme)
        const path = watches/${uid}/${Date.now()}_${file.name};
        const storageRef = ref(storage, path);

        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        urls.push(url);
      }

      return urls;
    }

    // ‚úÖ HAP FILE PICKER (iPhone friendly)
    chooseBtn.addEventListener("click", () => {
      fileInput.click();
    });

    // ‚úÖ kur zgjidhen foto
    fileInput.addEventListener("change", () => {
      setMsg(üìÇ U zgjodh√´n ${fileInput.files.length} foto);
    });

    // ‚úÖ TEST upload (vet√´m tregon mesazh)
    uploadBtn.addEventListener("click", async () => {
      if (fileInput.files.length === 0) {
        setMsg("‚ùå Zgjidh foto fillimisht");
        return;
      }
      setMsg("‚è≥ Duke kontrolluar fotot...");
      await new Promise(r => setTimeout(r, 400));
      setMsg(‚úÖ Gati (${fileInput.files.length}) ‚Äî tani kliko PUBLISH);
    });

    // ‚úÖ PUBLISH: upload + ruaj n√´ Firestore
    publishBtn.addEventListener("click", async () => {
      try {
        if (fileInput.files.length === 0) {
          setMsg("‚ùå Duhet t√´ zgjedh√´sh foto");
          return;
        }

        setMsg("‚è≥ Duke ngarkuar fotot...");
        const photoURLs = await uploadPhotos(userId);

        setMsg("‚è≥ Duke ruajtur n√´ database...");
        await addDoc(collection(db, "watches"), {
          brand,
          model,
          category,
          condition,
          price,
          material,
          photos: photoURLs,
          status: "active",
          userId,
          createdAt: serverTimestamp()
        });

        setMsg("üöÄ Publish OK me foto!");
        // Optional: pastro input-in
        // fileInput.value = "";
      } catch (err) {
        console.error(err);
        setMsg("‚ùå Error: " + (err?.message || err));
      }
    });

    // Debug i vog√´l
    console.log("SCRIPT OK");
  </script>

</body>
</html>

